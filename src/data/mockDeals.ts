import { Deal, CallActivity, BuyingSignal, Objection, CallRecord, HealthStatus } from '@/types/deals';

// Helper to generate dates
const daysAgo = (days: number) => {
  const date = new Date();
  date.setDate(date.getDate() - days);
  return date;
};

const hoursAgo = (hours: number) => {
  const date = new Date();
  date.setHours(date.getHours() - hours);
  return date;
};

// Generate buying signals
const generateBuyingSignals = (types: string[], baseDate: Date): BuyingSignal[] => {
  return types.map((type, i) => ({
    id: `bs-${Math.random().toString(36).substr(2, 9)}`,
    type: type as BuyingSignal['type'],
    label: {
      budget_confirmed: 'Budget Confirmed',
      timeline_set: 'Timeline Q1 2026',
      decision_maker_engaged: 'Decision Maker Engaged',
      champion_identified: 'Champion: VP Sales',
      pain_point_validated: 'Pain Point Validated',
      competitor_displaced: 'Displacing Gong',
      executive_sponsor: 'CFO Sponsor',
      technical_approval: 'IT Approved',
    }[type] || type,
    detectedAt: new Date(baseDate.getTime() - i * 24 * 60 * 60 * 1000),
    callId: `call-${i}`,
  }));
};

// Generate objections
const generateObjections = (texts: { text: string; response: string; resolved: boolean }[], baseDate: Date): Objection[] => {
  return texts.map((obj, i) => ({
    id: `obj-${Math.random().toString(36).substr(2, 9)}`,
    text: obj.text,
    suggestedResponse: obj.response,
    detectedAt: new Date(baseDate.getTime() - i * 24 * 60 * 60 * 1000),
    callId: `call-${i}`,
    resolved: obj.resolved,
  }));
};

// Generate call records
const generateCalls = (count: number, baseDate: Date, healthModifier: number): CallRecord[] => {
  const outcomes: ('positive' | 'neutral' | 'negative')[] = ['positive', 'neutral', 'negative'];
  return Array.from({ length: count }, (_, i) => ({
    id: `call-${Math.random().toString(36).substr(2, 9)}`,
    date: new Date(baseDate.getTime() - i * 3 * 24 * 60 * 60 * 1000),
    duration: 900 + Math.floor(Math.random() * 1800),
    score: Math.max(60, Math.min(95, 75 + healthModifier + Math.floor(Math.random() * 20 - 10))),
    summary: [
      'Discussed implementation timeline and technical requirements.',
      'Reviewed pricing proposal and addressed budget concerns.',
      'Demo completed successfully. Strong interest shown.',
      'Discovery call - identified key pain points around reporting.',
      'Follow-up on proposal. Awaiting legal review.',
    ][i % 5],
    outcome: outcomes[Math.floor(Math.random() * 3)],
    buyingSignals: ['Budget confirmed', 'Timeline set'].slice(0, Math.floor(Math.random() * 3)),
    objections: ['Pricing concerns', 'Need IT approval'].slice(0, Math.floor(Math.random() * 2)),
    contactName: ['John Smith', 'Sarah Johnson', 'Mike Chen', 'Lisa Wang'][i % 4],
  }));
};

// AT RISK Deals (3)
const atRiskDeals: Deal[] = [
  {
    id: 'deal-1',
    name: 'Enterprise Platform Upgrade',
    company: 'Quantum Solutions',
    contactName: 'Robert Chen',
    contactEmail: 'rchen@quantumsolutions.com',
    value: 85000,
    currency: 'USD',
    stage: 'proposal',
    healthScore: 32,
    healthStatus: 'at_risk',
    owner: 'user-1',
    ownerName: 'Alex Thompson',
    createdAt: daysAgo(45),
    updatedAt: daysAgo(12),
    lastCallDate: daysAgo(12),
    lastCallSummary: 'Prospect expressed concerns about implementation timeline. Mentioned they are also evaluating Gong. Need to follow up with case studies.',
    daysSinceLastCall: 12,
    nextAction: 'Schedule urgent follow-up call to address concerns',
    nextActionDueDate: daysAgo(-1),
    buyingSignals: generateBuyingSignals(['pain_point_validated'], daysAgo(20)),
    objections: generateObjections([
      { text: 'Implementation timeline too long', response: 'We can offer expedited onboarding with dedicated CSM support, typically reducing timeline by 40%.', resolved: false },
      { text: 'Need to evaluate competitors', response: 'Happy to provide a detailed comparison. Our AI coaching accuracy is 23% higher than Gong in head-to-head tests.', resolved: false },
    ], daysAgo(12)),
    competitorMentions: ['Gong', 'Chorus'],
    calls: generateCalls(4, daysAgo(12), -10),
  },
  {
    id: 'deal-2',
    name: 'Sales Team Expansion',
    company: 'Apex Industries',
    contactName: 'Jennifer Walsh',
    contactEmail: 'jwalsh@apexind.com',
    value: 42000,
    currency: 'USD',
    stage: 'negotiation',
    healthScore: 28,
    healthStatus: 'at_risk',
    owner: 'user-2',
    ownerName: 'Sarah Miller',
    createdAt: daysAgo(60),
    updatedAt: daysAgo(18),
    lastCallDate: daysAgo(18),
    lastCallSummary: 'Budget approval delayed due to Q4 freeze. Champion is pushing internally but timeline uncertain.',
    daysSinceLastCall: 18,
    nextAction: 'Re-engage after budget freeze lifts',
    nextActionDueDate: daysAgo(-5),
    buyingSignals: generateBuyingSignals(['champion_identified', 'pain_point_validated'], daysAgo(30)),
    objections: generateObjections([
      { text: 'Budget frozen until Q2', response: 'We can structure a deferred payment plan with Q2 start, locking in current pricing.', resolved: false },
      { text: 'CFO wants ROI proof', response: 'I can share our ROI calculator and 3 customer case studies showing 2.4x return within 6 months.', resolved: false },
    ], daysAgo(18)),
    competitorMentions: [],
    calls: generateCalls(3, daysAgo(18), -15),
  },
  {
    id: 'deal-3',
    name: 'Revenue Intelligence Suite',
    company: 'NovaTech Corp',
    contactName: 'David Park',
    contactEmail: 'dpark@novatech.io',
    value: 0, // $0 but this seems wrong, should have value
    currency: 'USD',
    stage: 'demo',
    healthScore: 35,
    healthStatus: 'at_risk',
    owner: 'user-1',
    ownerName: 'Alex Thompson',
    createdAt: daysAgo(21),
    updatedAt: daysAgo(8),
    lastCallDate: daysAgo(8),
    lastCallSummary: 'Demo went poorly. Technical issues during live demo caused frustration. Need to reschedule.',
    daysSinceLastCall: 8,
    nextAction: 'Reschedule demo with backup system ready',
    nextActionDueDate: daysAgo(-2),
    buyingSignals: [],
    objections: generateObjections([
      { text: 'Concerned about platform stability', response: 'Our platform has 99.97% uptime SLA. The demo issues were an isolated incident and I can show you our status page history.', resolved: false },
    ], daysAgo(8)),
    competitorMentions: ['Outreach'],
    calls: generateCalls(2, daysAgo(8), -20),
  },
];
// Update deal-3 value
atRiskDeals[2].value = 68000;

// MONITOR Deals (5)
const monitorDeals: Deal[] = [
  {
    id: 'deal-4',
    name: 'SDR Team Coaching',
    company: 'TechFlow Inc',
    contactName: 'Maria Santos',
    contactEmail: 'msantos@techflow.com',
    value: 28000,
    currency: 'USD',
    stage: 'qualified',
    healthScore: 55,
    healthStatus: 'monitor',
    owner: 'user-3',
    ownerName: 'James Wilson',
    createdAt: daysAgo(14),
    updatedAt: daysAgo(5),
    lastCallDate: daysAgo(5),
    lastCallSummary: 'Good discovery call. Identified key pain points around SDR ramp time. Requested pricing for 20-seat deployment.',
    daysSinceLastCall: 5,
    nextAction: 'Send pricing proposal with ROI analysis',
    nextActionDueDate: daysAgo(-1),
    buyingSignals: generateBuyingSignals(['pain_point_validated', 'timeline_set'], daysAgo(5)),
    objections: generateObjections([
      { text: 'Need to see integration with Salesforce', response: 'Our Salesforce integration is native and bi-directional. I can demo this specifically.', resolved: true },
    ], daysAgo(5)),
    competitorMentions: [],
    calls: generateCalls(2, daysAgo(5), 0),
  },
  {
    id: 'deal-5',
    name: 'Enterprise Rollout Phase 2',
    company: 'GlobalSync Ltd',
    contactName: 'Thomas Lee',
    contactEmail: 'tlee@globalsync.com',
    value: 156000,
    currency: 'USD',
    stage: 'proposal',
    healthScore: 52,
    healthStatus: 'monitor',
    owner: 'user-2',
    ownerName: 'Sarah Miller',
    createdAt: daysAgo(35),
    updatedAt: daysAgo(7),
    lastCallDate: daysAgo(7),
    lastCallSummary: 'Reviewed Phase 2 expansion proposal. Legal is reviewing MSA amendments. Expected 2-week turnaround.',
    daysSinceLastCall: 7,
    nextAction: 'Follow up on legal review status',
    nextActionDueDate: daysAgo(0),
    buyingSignals: generateBuyingSignals(['budget_confirmed', 'champion_identified', 'executive_sponsor'], daysAgo(10)),
    objections: generateObjections([
      { text: 'Legal concerns about data residency', response: 'We offer EU data residency options with SOC 2 Type II compliance for GDPR requirements.', resolved: false },
    ], daysAgo(7)),
    competitorMentions: [],
    calls: generateCalls(5, daysAgo(7), 5),
  },
  {
    id: 'deal-6',
    name: 'Pilot Program',
    company: 'Meridian Partners',
    contactName: 'Amanda Foster',
    contactEmail: 'afoster@meridian.co',
    value: 15000,
    currency: 'USD',
    stage: 'demo',
    healthScore: 58,
    healthStatus: 'monitor',
    owner: 'user-1',
    ownerName: 'Alex Thompson',
    createdAt: daysAgo(10),
    updatedAt: daysAgo(3),
    lastCallDate: daysAgo(3),
    lastCallSummary: 'Demo completed. Good reception from sales team. Manager wants to see ROI projections before pilot.',
    daysSinceLastCall: 3,
    nextAction: 'Prepare custom ROI analysis',
    nextActionDueDate: daysAgo(-2),
    buyingSignals: generateBuyingSignals(['pain_point_validated'], daysAgo(3)),
    objections: [],
    competitorMentions: ['Gong'],
    calls: generateCalls(2, daysAgo(3), 5),
  },
  {
    id: 'deal-7',
    name: 'Customer Success Enhancement',
    company: 'Pinnacle Group',
    contactName: 'Kevin Brooks',
    contactEmail: 'kbrooks@pinnacle.com',
    value: 34000,
    currency: 'USD',
    stage: 'qualified',
    healthScore: 48,
    healthStatus: 'monitor',
    owner: 'user-3',
    ownerName: 'James Wilson',
    createdAt: daysAgo(18),
    updatedAt: daysAgo(6),
    lastCallDate: daysAgo(6),
    lastCallSummary: 'Initial qualification complete. Strong fit for CS use case. Need to loop in their VP of CS.',
    daysSinceLastCall: 6,
    nextAction: 'Schedule call with VP of Customer Success',
    nextActionDueDate: daysAgo(-1),
    buyingSignals: generateBuyingSignals(['champion_identified'], daysAgo(6)),
    objections: generateObjections([
      { text: 'Not sure if it works for CS calls', response: 'We have specific playbooks for CS conversations including retention signals and upsell detection.', resolved: false },
    ], daysAgo(6)),
    competitorMentions: [],
    calls: generateCalls(2, daysAgo(6), 0),
  },
  {
    id: 'deal-8',
    name: 'APAC Expansion',
    company: 'SynergyTech Asia',
    contactName: 'Michelle Tan',
    contactEmail: 'mtan@synergytech.asia',
    value: 92000,
    currency: 'USD',
    stage: 'negotiation',
    healthScore: 51,
    healthStatus: 'monitor',
    owner: 'user-2',
    ownerName: 'Sarah Miller',
    createdAt: daysAgo(42),
    updatedAt: daysAgo(4),
    lastCallDate: daysAgo(4),
    lastCallSummary: 'Negotiating multi-year contract terms. Requesting volume discount for 100+ seats. Need approval for custom pricing.',
    daysSinceLastCall: 4,
    nextAction: 'Get approval for custom pricing tier',
    nextActionDueDate: daysAgo(-1),
    buyingSignals: generateBuyingSignals(['budget_confirmed', 'decision_maker_engaged', 'timeline_set'], daysAgo(10)),
    objections: generateObjections([
      { text: 'Need better pricing for volume', response: 'For 100+ seats we can offer a 25% volume discount with a 2-year commitment.', resolved: false },
    ], daysAgo(4)),
    competitorMentions: ['Salesken'],
    calls: generateCalls(6, daysAgo(4), 5),
  },
];

// ON TRACK Deals (7)
const onTrackDeals: Deal[] = [
  {
    id: 'deal-9',
    name: 'Full Platform Deployment',
    company: 'Velocity Dynamics',
    contactName: 'Christopher Adams',
    contactEmail: 'cadams@velocity.io',
    value: 124000,
    currency: 'USD',
    stage: 'negotiation',
    healthScore: 85,
    healthStatus: 'on_track',
    owner: 'user-1',
    ownerName: 'Alex Thompson',
    createdAt: daysAgo(28),
    updatedAt: daysAgo(1),
    lastCallDate: daysAgo(1),
    lastCallSummary: 'Final contract review. All terms agreed. Awaiting signature from CFO who is traveling until Friday.',
    daysSinceLastCall: 1,
    nextAction: 'Send contract for e-signature',
    nextActionDueDate: daysAgo(-2),
    buyingSignals: generateBuyingSignals(['budget_confirmed', 'decision_maker_engaged', 'champion_identified', 'executive_sponsor', 'technical_approval'], daysAgo(5)),
    objections: [],
    competitorMentions: [],
    calls: generateCalls(7, daysAgo(1), 15),
  },
  {
    id: 'deal-10',
    name: 'SMB Team Package',
    company: 'Bright Innovations',
    contactName: 'Nicole Harris',
    contactEmail: 'nharris@brightinnovations.com',
    value: 18000,
    currency: 'USD',
    stage: 'proposal',
    healthScore: 78,
    healthStatus: 'on_track',
    owner: 'user-3',
    ownerName: 'James Wilson',
    createdAt: daysAgo(12),
    updatedAt: daysAgo(2),
    lastCallDate: daysAgo(2),
    lastCallSummary: 'Proposal accepted in principle. Working on start date alignment with their Q2 hiring.',
    daysSinceLastCall: 2,
    nextAction: 'Confirm implementation start date',
    nextActionDueDate: daysAgo(-3),
    buyingSignals: generateBuyingSignals(['budget_confirmed', 'timeline_set', 'pain_point_validated'], daysAgo(5)),
    objections: [],
    competitorMentions: [],
    calls: generateCalls(3, daysAgo(2), 10),
  },
  {
    id: 'deal-11',
    name: 'Sales Enablement Suite',
    company: 'Atlas Corporation',
    contactName: 'Ryan Mitchell',
    contactEmail: 'rmitchell@atlascorp.com',
    value: 67000,
    currency: 'USD',
    stage: 'demo',
    healthScore: 72,
    healthStatus: 'on_track',
    owner: 'user-2',
    ownerName: 'Sarah Miller',
    createdAt: daysAgo(8),
    updatedAt: daysAgo(1),
    lastCallDate: daysAgo(1),
    lastCallSummary: 'Excellent demo session. Team was very engaged. Moving to proposal stage next week.',
    daysSinceLastCall: 1,
    nextAction: 'Prepare detailed proposal',
    nextActionDueDate: daysAgo(-4),
    buyingSignals: generateBuyingSignals(['decision_maker_engaged', 'pain_point_validated', 'champion_identified'], daysAgo(1)),
    objections: [],
    competitorMentions: [],
    calls: generateCalls(2, daysAgo(1), 12),
  },
  {
    id: 'deal-12',
    name: 'Coaching Platform Upgrade',
    company: 'Stellar Systems',
    contactName: 'Laura Chen',
    contactEmail: 'lchen@stellarsystems.com',
    value: 45000,
    currency: 'USD',
    stage: 'qualified',
    healthScore: 68,
    healthStatus: 'on_track',
    owner: 'user-1',
    ownerName: 'Alex Thompson',
    createdAt: daysAgo(7),
    updatedAt: daysAgo(2),
    lastCallDate: daysAgo(2),
    lastCallSummary: 'Strong qualification call. Clear budget and timeline. Demo scheduled for next week.',
    daysSinceLastCall: 2,
    nextAction: 'Prepare customized demo',
    nextActionDueDate: daysAgo(-5),
    buyingSignals: generateBuyingSignals(['budget_confirmed', 'timeline_set'], daysAgo(2)),
    objections: [],
    competitorMentions: [],
    calls: generateCalls(1, daysAgo(2), 8),
  },
  {
    id: 'deal-13',
    name: 'Regional Sales Team',
    company: 'Horizon Media',
    contactName: 'Daniel Wright',
    contactEmail: 'dwright@horizonmedia.com',
    value: 38000,
    currency: 'USD',
    stage: 'proposal',
    healthScore: 75,
    healthStatus: 'on_track',
    owner: 'user-3',
    ownerName: 'James Wilson',
    createdAt: daysAgo(16),
    updatedAt: daysAgo(1),
    lastCallDate: daysAgo(1),
    lastCallSummary: 'Reviewing proposal with their finance team. Positive signals on moving forward.',
    daysSinceLastCall: 1,
    nextAction: 'Follow up on finance review',
    nextActionDueDate: daysAgo(-2),
    buyingSignals: generateBuyingSignals(['budget_confirmed', 'champion_identified', 'pain_point_validated'], daysAgo(3)),
    objections: [],
    competitorMentions: [],
    calls: generateCalls(4, daysAgo(1), 10),
  },
  {
    id: 'deal-14',
    name: 'Enterprise AI Coaching',
    company: 'Summit Ventures',
    contactName: 'Patricia Green',
    contactEmail: 'pgreen@summitvntures.com',
    value: 89000,
    currency: 'USD',
    stage: 'negotiation',
    healthScore: 82,
    healthStatus: 'on_track',
    owner: 'user-2',
    ownerName: 'Sarah Miller',
    createdAt: daysAgo(32),
    updatedAt: daysAgo(0),
    lastCallDate: daysAgo(0),
    lastCallSummary: 'Contract redlined and returned. Minor adjustments needed. Expect to close this week.',
    daysSinceLastCall: 0,
    nextAction: 'Review and accept redlines',
    nextActionDueDate: daysAgo(-1),
    buyingSignals: generateBuyingSignals(['budget_confirmed', 'decision_maker_engaged', 'executive_sponsor', 'technical_approval'], daysAgo(7)),
    objections: [],
    competitorMentions: [],
    calls: generateCalls(6, daysAgo(0), 15),
  },
  {
    id: 'deal-15',
    name: 'Startup Growth Package',
    company: 'Ignite Labs',
    contactName: 'Marcus Johnson',
    contactEmail: 'mjohnson@ignitelabs.co',
    value: 12000,
    currency: 'USD',
    stage: 'demo',
    healthScore: 70,
    healthStatus: 'on_track',
    owner: 'user-1',
    ownerName: 'Alex Thompson',
    createdAt: daysAgo(5),
    updatedAt: daysAgo(1),
    lastCallDate: daysAgo(1),
    lastCallSummary: 'Fast-moving startup. CEO wants to pilot with 5 seats. Very enthusiastic about AI features.',
    daysSinceLastCall: 1,
    nextAction: 'Send pilot agreement',
    nextActionDueDate: daysAgo(-1),
    buyingSignals: generateBuyingSignals(['decision_maker_engaged', 'timeline_set'], daysAgo(1)),
    objections: [],
    competitorMentions: [],
    calls: generateCalls(2, daysAgo(1), 10),
  },
];

export const mockDeals: Deal[] = [...atRiskDeals, ...monitorDeals, ...onTrackDeals];

// Generate call activities from deals
export const generateMockCallActivities = (): CallActivity[] => {
  const activities: CallActivity[] = [];
  
  mockDeals.forEach(deal => {
    deal.calls.forEach(call => {
      activities.push({
        id: call.id,
        date: call.date,
        duration: call.duration,
        score: call.score,
        contactName: call.contactName || deal.contactName,
        company: deal.company,
        dealId: deal.id,
        dealName: deal.name,
        userId: deal.owner,
        userName: deal.ownerName,
        summary: call.summary,
        buyingSignals: call.buyingSignals,
        objections: call.objections.map(o => ({
          text: o,
          suggestedResponse: 'AI-generated response suggestion for this objection.',
        })),
        competitorMentions: deal.competitorMentions,
        outcome: call.outcome,
        nextSteps: deal.nextAction || 'Follow up as needed.',
      });
    });
  });

  // Add some standalone calls not linked to deals
  const standaloneCalls: CallActivity[] = [
    {
      id: 'call-standalone-1',
      date: hoursAgo(3),
      duration: 1245,
      score: 78,
      contactName: 'Emma Richardson',
      company: 'Cascade Analytics',
      dealId: null,
      dealName: null,
      userId: 'user-1',
      userName: 'Alex Thompson',
      summary: 'Initial discovery call. Prospect is exploring options for their 50-person sales team. Good fit but early stage.',
      buyingSignals: ['Pain point identified'],
      objections: [],
      competitorMentions: [],
      outcome: 'positive',
      nextSteps: 'Create deal and schedule follow-up demo.',
    },
    {
      id: 'call-standalone-2',
      date: hoursAgo(6),
      duration: 890,
      score: 65,
      contactName: 'Brian Foster',
      company: 'Metro Solutions',
      dealId: null,
      dealName: null,
      userId: 'user-2',
      userName: 'Sarah Miller',
      summary: 'Cold outreach call. Not the right timing but asked to follow up in Q3.',
      buyingSignals: [],
      objections: [{ text: 'Not the right time', suggestedResponse: 'Understood. I\'ll set a reminder to reconnect in Q3 when timing is better.' }],
      competitorMentions: [],
      outcome: 'neutral',
      nextSteps: 'Add to Q3 follow-up list.',
    },
  ];

  return [...activities, ...standaloneCalls].sort((a, b) => b.date.getTime() - a.date.getTime());
};

export const mockCallActivities = generateMockCallActivities();

export const calculatePipelineSummary = (deals: Deal[]): { atRiskCount: number; atRiskValue: number; monitorCount: number; monitorValue: number; onTrackCount: number; onTrackValue: number; totalValue: number; totalDeals: number } => {
  const activeDeals = deals.filter(d => d.stage !== 'closed_won' && d.stage !== 'closed_lost');
  
  const atRisk = activeDeals.filter(d => d.healthStatus === 'at_risk');
  const monitor = activeDeals.filter(d => d.healthStatus === 'monitor');
  const onTrack = activeDeals.filter(d => d.healthStatus === 'on_track');

  return {
    atRiskCount: atRisk.length,
    atRiskValue: atRisk.reduce((sum, d) => sum + d.value, 0),
    monitorCount: monitor.length,
    monitorValue: monitor.reduce((sum, d) => sum + d.value, 0),
    onTrackCount: onTrack.length,
    onTrackValue: onTrack.reduce((sum, d) => sum + d.value, 0),
    totalValue: activeDeals.reduce((sum, d) => sum + d.value, 0),
    totalDeals: activeDeals.length,
  };
};
